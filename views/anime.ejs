<%- include('partials/header', { q: '' }) %>
<section class="anime-hero">
  <img class="cover" src="<%= anime.cover_path || '/public/img/placeholder.svg' %>" alt="<%= anime.title %>"/>
  <div class="meta">
    <h1><%= anime.title %></h1>
    <div class="tags">
      <% genres.forEach(g => { %><span class="tag"><%= g %></span><% }) %>
    </div>
    <p class="desc"><%= anime.description %></p>
    <div class="actions anime-actions">
      <% if (user) { %>
        <% if (isFav) { %>
          <button class="btn" id="favBtn" data-anime="<%= anime.id %>" data-state="on">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke="none" d="M12 2l2.9 6 6.6.9-4.8 4.6 1.2 6.5-5.9-3.2-5.9 3.2 1.2-6.5L2.5 8.9 9.1 8z" />
            </svg>
            <span>В избранном</span>
          </button>
        <% } else { %>
          <button class="btn" id="favBtn" data-anime="<%= anime.id %>" data-state="off">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="none" stroke-width="2" d="M12 2l2.9 6 6.6.9-4.8 4.6 1.2 6.5-5.9-3.2-5.9 3.2 1.2-6.5L2.5 8.9 9.1 8z" />
            </svg>
            <span>В избранное</span>
          </button>
        <% } %>
      <% } %>
      <div class="reaction">
        <% if (user) { %>
          <button class="btn like-btn <%= userLike === 1 ? 'active' : '' %>" id="likeBtn" data-anime="<%= anime.id %>" data-state="<%= userLike === 1 ? 'on' : 'off' %>">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke="none" d="M2 10h4v10H2z" />
              <path stroke="none" d="M6 20h11a2 2 0 0 0 2-1.6l2-7A2 2 0 0 0 19 9h-6l1-5-2-2-6 8v10z" />
            </svg>
            <span class="like-text">Лайк</span>
          </button>
        <% } else { %>
          <a class="btn" href="/login">Войти чтобы лайкнуть</a>
        <% } %>
        <span class="like-count" id="likeCount"><%= likeCount %></span>
      </div>
    </div>
  </div>
</section>

<section class="section">
  <h3>Episodes</h3>
  <div class="episodes-grid">
    <% episodes.forEach(e => { %>
      <a class="episode-card" href="/watch/<%= e.id %>">
        <div class="episode-number">Серия <%= e.number %></div>
        <div class="episode-title"><%= e.title || ('Episode ' + e.number) %></div>
        <div class="episode-action">
          Смотреть
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="none" stroke-width="2" d="M9 6l6 6-6 6" />
          </svg>
        </div>
      </a>
    <% }) %>
  </div>
</section>

<section class="section">
  <h3>Comments</h3>
  <% if (user) { %>
  <form id="commentForm" class="comment-form">
    <input type="hidden" name="anime_id" value="<%= anime.id %>"/>
    <textarea name="content" rows="3" placeholder="Write a comment..."></textarea>
    <button class="btn primary">Post</button>
  </form>
  <% } else { %>
    <p><a href="/login">Login</a> to comment.</p>
  <% } %>
  <div class="comments">
    <% comments.forEach(c => { %>
      <div class="comment">
        <img class="comment-avatar" src="<%= c.avatar_path || '/public/img/placeholder.webp' %>" alt="<%= c.username %>"/>
        <div class="comment-content">
          <strong class="user-name">
            <a href="/user/<%= c.username %>"><%= c.username %></a>
            <% if (c.is_verified) { %>
              <img class="checkmark" src="/public/img/checkmark.png" alt="Verified" />
            <% } %>
          </strong>
          <span><%= new Date(c.created_at).toLocaleString() %></span>
          <p><%= c.content %></p>
        </div>
      </div>
    <% }) %>
  </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const favBtn = document.getElementById('favBtn');
  if (favBtn) {
    favBtn.addEventListener('click', async () => {
      const id = favBtn.dataset.anime;
      const state = favBtn.dataset.state;
      const labels = {
        on:
          '<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path stroke="none" d="M12 2l2.9 6 6.6.9-4.8 4.6 1.2 6.5-5.9-3.2-5.9 3.2 1.2-6.5L2.5 8.9 9.1 8z" /></svg><span>В избранном</span>',
        off:
          '<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="none" stroke-width="2" d="M12 2l2.9 6 6.6.9-4.8 4.6 1.2 6.5-5.9-3.2-5.9 3.2 1.2-6.5L2.5 8.9 9.1 8z" /></svg><span>В избранное</span>',
      };
      if (state === 'off') {
        const r = await fetch(`/anime/${id}/favorite`, {method:'POST'});
        if (r.ok) { favBtn.dataset.state='on'; favBtn.innerHTML = labels.on; }
      } else {
        const r = await fetch(`/anime/${id}/favorite`, {method:'DELETE'});
        if (r.ok) { favBtn.dataset.state='off'; favBtn.innerHTML = labels.off; }
      }
    });
  }
  const likeBtn = document.getElementById('likeBtn');
  if (likeBtn) {
    likeBtn.addEventListener('click', async () => {
      const state = likeBtn.dataset.state;
      if (state === 'on') return;
      const animeId = likeBtn.dataset.anime;
      const r = await fetch('/like', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ anime_id: animeId, value: 1 })
      });
      if (r.ok) {
        likeBtn.dataset.state = 'on';
        likeBtn.classList.add('active');
        const countEl = document.getElementById('likeCount');
        if (countEl) countEl.textContent = String(Number(countEl.textContent || 0) + 1);
      }
    });
  }
  const form = document.getElementById('commentForm');
  if (form) {
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = new FormData(form);
      const payload = Object.fromEntries(data.entries());
      const r = await fetch('/comments', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (r.ok) location.reload();
    });
  }
});
</script>
<%- include('partials/footer') %>

