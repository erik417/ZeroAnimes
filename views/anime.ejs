<%- include('partials/header', { q: '' }) %>
<section class="anime-hero">
  <img class="cover" src="<%= anime.cover_path || '/public/img/placeholder.svg' %>" alt="<%= anime.title %>"/>
  <div class="meta">
    <h1><%= anime.title %></h1>
    <div class="tags">
      <% genres.forEach(g => { %><span class="tag"><%= g %></span><% }) %>
    </div>
    <p class="desc"><%= anime.description %></p>
    <div class="actions anime-actions">
      <% if (user) { %>
        <% if (isFav) { %>
          <button class="btn" id="favBtn" data-anime="<%= anime.id %>" data-state="on">‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º</button>
        <% } else { %>
          <button class="btn" id="favBtn" data-anime="<%= anime.id %>" data-state="off">‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <% } %>
      <% } %>
      <div class="reaction">
        <% if (user) { %>
          <button class="btn like-btn <%= userLike === 1 ? 'active' : '' %>" id="likeBtn" data-anime="<%= anime.id %>" data-state="<%= userLike === 1 ? 'on' : 'off' %>">üëç <span class="like-text">–õ–∞–π–∫</span></button>
        <% } else { %>
          <a class="btn" href="/login">–í–æ–π—Ç–∏ —á—Ç–æ–±—ã –ª–∞–π–∫–Ω—É—Ç—å</a>
        <% } %>
        <span class="like-count" id="likeCount"><%= likeCount %></span>
      </div>
    </div>
  </div>
</section>

<section class="section">
  <h3>Episodes</h3>
  <div class="episodes-grid">
    <% episodes.forEach(e => { %>
      <a class="episode-card" href="/watch/<%= e.id %>">
        <div class="episode-number">–°–µ—Ä–∏—è <%= e.number %></div>
        <div class="episode-title"><%= e.title || ('Episode ' + e.number) %></div>
        <div class="episode-action">–°–º–æ—Ç—Ä–µ—Ç—å ‚Üí</div>
      </a>
    <% }) %>
  </div>
</section>

<section class="section">
  <h3>Comments</h3>
  <% if (user) { %>
  <form id="commentForm" class="comment-form">
    <input type="hidden" name="anime_id" value="<%= anime.id %>"/>
    <textarea name="content" rows="3" placeholder="Write a comment..."></textarea>
    <button class="btn primary">Post</button>
  </form>
  <% } else { %>
    <p><a href="/login">Login</a> to comment.</p>
  <% } %>
  <div class="comments">
    <% comments.forEach(c => { %>
      <div class="comment">
        <strong><%= c.username %></strong>
        <span><%= new Date(c.created_at).toLocaleString() %></span>
        <p><%= c.content %></p>
      </div>
    <% }) %>
  </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const favBtn = document.getElementById('favBtn');
  if (favBtn) {
    favBtn.addEventListener('click', async () => {
      const id = favBtn.dataset.anime;
      const state = favBtn.dataset.state;
      const labels = { on: '‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º', off: '‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' };
      if (state === 'off') {
        const r = await fetch(`/anime/${id}/favorite`, {method:'POST'});
        if (r.ok) { favBtn.dataset.state='on'; favBtn.textContent = labels.on; }
      } else {
        const r = await fetch(`/anime/${id}/favorite`, {method:'DELETE'});
        if (r.ok) { favBtn.dataset.state='off'; favBtn.textContent = labels.off; }
      }
    });
  }
  const likeBtn = document.getElementById('likeBtn');
  if (likeBtn) {
    likeBtn.addEventListener('click', async () => {
      const state = likeBtn.dataset.state;
      if (state === 'on') return;
      const animeId = likeBtn.dataset.anime;
      const r = await fetch('/like', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ anime_id: animeId, value: 1 })
      });
      if (r.ok) {
        likeBtn.dataset.state = 'on';
        likeBtn.classList.add('active');
        const countEl = document.getElementById('likeCount');
        if (countEl) countEl.textContent = String(Number(countEl.textContent || 0) + 1);
      }
    });
  }
  const form = document.getElementById('commentForm');
  if (form) {
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = new FormData(form);
      const payload = Object.fromEntries(data.entries());
      const r = await fetch('/comments', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (r.ok) location.reload();
    });
  }
});
</script>
<%- include('partials/footer') %>

