<%- include('partials/header', { q: '' }) %>
<section class="section">
  <div class="card profile-card">
    <div class="card-body profile-head">
      <img class="avatar" src="<%= profileUser.avatar_path || '/public/img/placeholder.webp' %>" alt="<%= profileUser.username %>" />
      <div class="profile-info">
        <div class="profile-name">
          <strong><%= profileUser.username %></strong>
          <% if (profileUser.is_verified) { %>
            <img class="checkmark" src="/public/img/checkmark.png" alt="Verified" />
          <% } %>
        </div>
        <% if (profileUser.bio) { %>
          <p class="profile-bio"><%= profileUser.bio %></p>
        <% } %>
        <div class="profile-meta">
          <span>Избранное: <%= stats.favoritesCount %></span>
          <span>Подписчики: <%= stats.followersCount %></span>
          <span>Подписки: <%= stats.followingCount %></span>
          <span>Лайки: <%= stats.likesCount %></span>
          <span>Посты: <%= stats.postsCount %></span>
        </div>
        <% if (!isSelf) { %>
          <div class="profile-actions">
            <% if (isFollowing) { %>
              <form action="/user/<%= profileUser.username %>/unfollow" method="post">
                <button class="btn">Отписаться</button>
              </form>
            <% } else { %>
              <form action="/user/<%= profileUser.username %>/follow" method="post">
                <button class="btn primary">Подписаться</button>
              </form>
            <% } %>
            <a class="btn" href="/chat/<%= profileUser.username %>">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke="none" d="M4 5h16v10H7l-3 3z" />
              </svg>
              Чат
            </a>
          </div>
        <% } else { %>
          <a class="btn" href="/profile/edit">Редактировать профиль</a>
        <% } %>
      </div>
    </div>
  </div>
</section>

<section class="section">
  <h3>Избранное</h3>
  <div class="card-grid">
    <% favorites.forEach(a => { %>
      <a class="card" href="/anime/<%= a.slug %>">
        <img src="<%= a.cover_path || '/public/img/placeholder.svg' %>" alt="<%= a.title %>"/>
        <div class="card-body">
          <h4><%= a.title %></h4>
        </div>
      </a>
    <% }) %>
    <% if (favorites.length === 0) { %>
      <p>Пока нет избранного.</p>
    <% } %>
  </div>
</section>

<section class="section">
  <div class="profile-tabs">
    <button class="tab-btn active" data-tab="posts">Посты</button>
    <button class="tab-btn" data-tab="followers">Подписчики</button>
    <button class="tab-btn" data-tab="following">Подписки</button>
  </div>
  <div class="tab-panel active" id="tab-posts">
    <% posts.forEach(p => { %>
      <div class="card forum-post">
        <div class="card-body">
          <div class="forum-head">
            <strong><%= p.title %></strong>
            <div class="forum-head-actions">
              <span><%= new Date(p.created_at).toLocaleString() %></span>
              <% if (user && user.username === 'er1kos') { %>
                <div class="post-menu">
                  <button class="post-menu-btn" type="button" aria-label="Меню поста">⋯</button>
                  <div class="post-menu-list">
                    <form class="post-menu-form" action="/forum/<%= p.id %>/delete" method="post">
                      <button class="post-menu-item danger" type="submit">Удалить</button>
                    </form>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
          <p><%= p.content %></p>
          <% if (String(p.video_url || '').trim()) { %>
            <video class="forum-video" src="<%= p.video_url %>" controls></video>
          <% } %>
          <div class="post-reactions">
            <% if (user) { %>
              <form action="/forum/<%= p.id %>/react" method="post">
                <input type="hidden" name="value" value="<%= Number(p.my_reaction) === 1 ? 0 : 1 %>" />
                <button class="reaction-btn <%= Number(p.my_reaction) === 1 ? 'active' : '' %>">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke="none" d="M2 10h4v10H2z" />
                    <path stroke="none" d="M6 20h11a2 2 0 0 0 2-1.6l2-7A2 2 0 0 0 19 9h-6l1-5-2-2-6 8v10z" />
                  </svg>
                  <span><%= p.like_count %></span>
                </button>
              </form>
              <form action="/forum/<%= p.id %>/react" method="post">
                <input type="hidden" name="value" value="<%= Number(p.my_reaction) === -1 ? 0 : -1 %>" />
                <button class="reaction-btn <%= Number(p.my_reaction) === -1 ? 'active' : '' %>">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke="none" d="M2 4h4v10H2z" />
                    <path stroke="none" d="M6 4h11a2 2 0 0 1 2 1.6l2 7A2 2 0 0 1 19 15h-6l1 5-2 2-6-8V4z" />
                  </svg>
                  <span><%= p.dislike_count %></span>
                </button>
              </form>
            <% } else { %>
              <span class="reaction-count">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke="none" d="M2 10h4v10H2z" />
                  <path stroke="none" d="M6 20h11a2 2 0 0 0 2-1.6l2-7A2 2 0 0 0 19 9h-6l1-5-2-2-6 8v10z" />
                </svg>
                <%= p.like_count %>
              </span>
              <span class="reaction-count">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke="none" d="M2 4h4v10H2z" />
                  <path stroke="none" d="M6 4h11a2 2 0 0 1 2 1.6l2 7A2 2 0 0 1 19 15h-6l1 5-2 2-6-8V4z" />
                </svg>
                <%= p.dislike_count %>
              </span>
            <% } %>
            <span class="reaction-count">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke="none" d="M4 5h16v10H7l-3 3z" />
              </svg>
              <%= p.comment_count %>
            </span>
          </div>
          <div class="post-comments">
            <% (commentsMap[p.id] || []).forEach(c => { const avatar = String(c.avatar_path || '').trim(); const avatarSrc = avatar ? (avatar.startsWith('/') ? avatar : '/' + avatar) : '/public/img/placeholder.webp'; %>
              <div class="comment">
                <img class="comment-avatar" src="<%= avatarSrc %>" alt="<%= c.username %>"/>
                <div class="comment-content">
                  <div class="comment-head">
                    <strong class="user-name">
                      <a href="/user/<%= c.username %>"><%= c.username %></a>
                      <% if (c.is_verified) { %>
                        <img class="checkmark" src="/public/img/checkmark.png" alt="Verified" />
                      <% } %>
                    </strong>
                    <% if (user) { %>
                      <div class="comment-menu">
                        <button class="comment-menu-btn" type="button" aria-label="Меню комментария">⋯</button>
                        <div class="comment-menu-list">
                          <button class="comment-menu-item reply-action" type="button" data-post="<%= p.id %>" data-comment="<%= c.id %>" data-user="<%= c.username %>">Ответить</button>
                          <% if (user && user.id === c.user_id) { %>
                            <button class="comment-menu-item edit-action" type="button">Изменить</button>
                          <% } %>
                          <% if (user && (user.id === c.user_id || user.id === p.user_id || user.is_admin)) { %>
                            <form class="comment-menu-form" action="/forum/comments/<%= c.id %>/delete" method="post">
                              <button class="comment-menu-item danger" type="submit">Удалить</button>
                            </form>
                          <% } %>
                        </div>
                      </div>
                    <% } %>
                  </div>
                  <span><%= new Date(c.created_at).toLocaleString() %></span>
                  <% if (c.reply_to_username) { %>
                    <div class="reply-tag">Ответ @<%= c.reply_to_username %></div>
                  <% } %>
                  <p><%= c.content %></p>
                  <% if (user && user.id === c.user_id) { %>
                    <form class="comment-edit" action="/forum/comments/<%= c.id %>/edit" method="post">
                      <textarea name="content" rows="2" required><%= c.content %></textarea>
                      <button class="btn small">Сохранить</button>
                    </form>
                  <% } %>
                </div>
              </div>
            <% }) %>
            <% if ((commentsMap[p.id] || []).length === 0) { %>
              <p>Комментариев пока нет.</p>
            <% } %>
            <% if (user) { %>
              <form class="comment-form" action="/forum/<%= p.id %>/comment" method="post" data-post="<%= p.id %>">
                <input type="hidden" name="reply_to" value="" />
                <div class="reply-target"></div>
                <textarea name="content" rows="3" placeholder="Напишите комментарий..." required></textarea>
                <button class="btn primary">Отправить</button>
              </form>
            <% } else { %>
              <p><a href="/login">Войти</a> чтобы комментировать.</p>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
    <% if (posts.length === 0) { %>
      <p>Пока нет постов.</p>
    <% } %>
  </div>
  <script>
    const closeMenus = () => {
      document.querySelectorAll('.comment-menu.open, .post-menu.open').forEach((m) =>
        m.classList.remove('open')
      );
    };
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.comment-menu') && !e.target.closest('.post-menu')) closeMenus();
    });
    document.querySelectorAll('.comment-menu-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = btn.closest('.comment-menu');
        const isOpen = menu.classList.contains('open');
        closeMenus();
        if (!isOpen) menu.classList.add('open');
      });
    });
    document.querySelectorAll('.post-menu-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = btn.closest('.post-menu');
        const isOpen = menu.classList.contains('open');
        closeMenus();
        if (!isOpen) menu.classList.add('open');
      });
    });
    document.querySelectorAll('.reply-action').forEach((btn) => {
      btn.addEventListener('click', () => {
        const postId = btn.dataset.post;
        const commentId = btn.dataset.comment;
        const username = btn.dataset.user;
        const form = document.querySelector(`form.comment-form[data-post="${postId}"]`);
        if (!form) return;
        const input = form.querySelector('input[name="reply_to"]');
        const target = form.querySelector('.reply-target');
        const textarea = form.querySelector('textarea');
        input.value = commentId;
        if (target) {
          target.innerHTML = `Ответ @${username} <button type="button" class="reply-cancel">Отмена</button>`;
          target.classList.add('active');
          const cancel = target.querySelector('.reply-cancel');
          cancel.addEventListener('click', () => {
            input.value = '';
            target.textContent = '';
            target.classList.remove('active');
          });
        }
        if (!textarea.value.startsWith(`@${username} `)) {
          textarea.value = `@${username} ${textarea.value}`.trimStart();
        }
        textarea.focus();
        closeMenus();
      });
    });
    document.querySelectorAll('.edit-action').forEach((btn) => {
      btn.addEventListener('click', () => {
        const comment = btn.closest('.comment');
        const form = comment ? comment.querySelector('.comment-edit') : null;
        if (!form) return;
        form.classList.add('active');
        const textarea = form.querySelector('textarea');
        if (textarea) textarea.focus();
        closeMenus();
      });
    });
  </script>
  <div class="tab-panel" id="tab-followers">
    <div class="list">
      <% followers.forEach(u => { %>
        <div class="list-item">
          <a href="/user/<%= u.username %>"><%= u.username %></a>
          <% if (u.is_verified) { %>
            <img class="checkmark" src="/public/img/checkmark.png" alt="Verified" />
          <% } %>
        </div>
      <% }) %>
      <% if (followers.length === 0) { %>
        <p>Нет подписчиков.</p>
      <% } %>
    </div>
  </div>
  <div class="tab-panel" id="tab-following">
    <div class="list">
      <% following.forEach(u => { %>
        <div class="list-item">
          <a href="/user/<%= u.username %>"><%= u.username %></a>
          <% if (u.is_verified) { %>
            <img class="checkmark" src="/public/img/checkmark.png" alt="Verified" />
          <% } %>
        </div>
      <% }) %>
      <% if (following.length === 0) { %>
        <p>Нет подписок.</p>
      <% } %>
    </div>
  </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const buttons = document.querySelectorAll('.tab-btn');
  const panels = document.querySelectorAll('.tab-panel');
  buttons.forEach((btn) => {
    btn.addEventListener('click', () => {
      buttons.forEach((b) => b.classList.remove('active'));
      panels.forEach((p) => p.classList.remove('active'));
      btn.classList.add('active');
      const target = document.getElementById(`tab-${btn.dataset.tab}`);
      if (target) target.classList.add('active');
    });
  });
});
</script>
<%- include('partials/footer') %>
